<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Annotation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script
      src="https://unpkg.com/@pdf-lib/fontkit@1.0.0/dist/fontkit.umd.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen">
      <!-- Left Side - Form -->
      <div class="w-1/4 bg-white p-6 border-r border-gray-200">
        <h2 class="text-2xl font-bold mb-6">Annotation Form</h2>
        <form id="annotationForm" class="space-y-4">
          <div class="flex items-center gap-2">
            <label class="block w-16 text-sm font-medium mb-1">Domain</label>
            <input type="text" id="domain"
              class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
              value="grove.xiber.net">
          </div>

          <div class="flex flex-col gap-2">
            <span>Speed (Included)</span>
            <div class="flex flex-col p-2 border rounded-lg gap-2">
              <div class="flex items-center gap-2">
                <label class="block w-16 text-sm font-medium mb-1">Speed</label>
                <input type="text" id="included-speed"
                  class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                  value="400/400">
              </div>
              <div class="flex items-center gap-2">
                <label class="block w-16 text-sm font-medium mb-1">Units</label>
                <input type="text" id="included-units"
                  class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                  value="MBPS">
              </div>
            </div>
          </div>

          <div class="flex flex-col gap-2">
            <span>Speed (Additional)</span>
            <div class="flex flex-col p-2 border rounded-lg gap-2">
              <div class="flex items-center gap-2">
                <label class="block w-16 text-sm font-medium mb-1">Speed</label>
                <input type="text" id="additional-speed"
                  class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                  value="1/1">
              </div>
              <div class="flex items-center gap-2">
                <label class="block w-16 text-sm font-medium mb-1">Units</label>
                <input type="text" id="additional-units"
                  class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                  value="GBPS">
              </div>
              <div class="flex items-center gap-2">
                <label class="block w-16 text-sm font-medium mb-1">Price</label>
                <input type="text" id="additional-price"
                  class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                  value="25">
              </div>
            </div>
          </div>

          <button type="button" onclick="handleConfirm()"
            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
            Update & Preview
          </button>
          <button type="button" onclick="handleDownload()"
            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
            Download PDF
          </button>
        </form>
      </div>

      <!-- Right Side - PDF Preview -->
      <div class="w-3/4 relative p-4">
        <iframe id="pdfPreview"
          class="w-full h-full border-2 border-gray-300 rounded-lg"></iframe>
      </div>
    </div>

    <script>
let currentPdfBlob = null;

async function generateQRCode(text) {
    return new Promise((resolve) => {
        const qrContainer = document.createElement('div');
        document.body.appendChild(qrContainer);
        
        new QRCode(qrContainer, {
            text: text,
            width: 150,
            height: 150,
            correctLevel: QRCode.CorrectLevel.H,
        });

        const qrImage = qrContainer.querySelector('img');
        qrImage.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = qrImage.width + 30;
            canvas.height = qrImage.height + 30;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(qrImage, 15, 15);
            
            document.body.removeChild(qrContainer);
            resolve(canvas.toDataURL('image/png'));
        };
    });
}

async function handleConfirm() {
    const domain = document.getElementById('domain').value;
    const includedSpeed = document.getElementById('included-speed').value;
    const includedUnits = document.getElementById('included-units').value;
    const additionalSpeed = document.getElementById('additional-speed').value;
    const additionalUnits = document.getElementById('additional-units').value;
    const additionalPrice = document.getElementById('additional-price').value;

    const pdfUrl = './grove.pdf';
    const existingPdfBytes = await fetch(pdfUrl).then(res => res.arrayBuffer());
    
    const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
    pdfDoc.registerFontkit(fontkit);

    const BrandonBoldFontUrl = './Brandon Grotesque Bold.ttf';
    const BrandonBoldFontBytes = await fetch(BrandonBoldFontUrl).then(res => res.arrayBuffer());
    const BrandonBold = await pdfDoc.embedFont(BrandonBoldFontBytes);
    
    const GraphieBoldFontUrl = './Graphie Bold.ttf';
    const GraphieBoldFontBytes = await fetch(GraphieBoldFontUrl).then(res => res.arrayBuffer());
    const GraphieBold = await pdfDoc.embedFont(GraphieBoldFontBytes);

    const qrDataUrl = await generateQRCode(domain);
    const qrImageBytes = await fetch(qrDataUrl).then(res => res.arrayBuffer());
    const qrImage = await pdfDoc.embedPng(qrImageBytes);

    const pages = pdfDoc.getPages();
    for (const page of pages) {
        const { width, height } = page.getSize();

        // Helper function to get text width
        const getTextWidth = (text, font, size) => {
            return font.widthOfTextAtSize(text, size);
        };
        
        // Domain
        page.drawText(domain, {
            x: 87,
            y: height - 190,
            size: 44,
            font: BrandonBold,
            color: PDFLib.rgb(1, 1, 1)
        });

        // Included Speed with dynamic positioning
        const includedSpeedX = 253;
        const includedSpeedText = `${includedSpeed}`;
        const includedSpeedWidth = getTextWidth(includedSpeedText, GraphieBold, 31);
        
        page.drawText(includedSpeedText, {
            x: includedSpeedX,
            y: height - 343,
            size: 33,
            font: GraphieBold,
            color: PDFLib.rgb(0, 0, 0)
        });

        page.drawText(`${includedUnits}`, {
            x: includedSpeedX + includedSpeedWidth + 10,
            y: height - 337,
            size: 14,
            font: GraphieBold,
            color: PDFLib.rgb(0, 0, 0)
        });

        // Additional Speed with dynamic positioning
        const additionalSpeedX = 253;
        const additionalSpeedText = `${additionalSpeed}`;
        const additionalSpeedWidth = getTextWidth(additionalSpeedText, GraphieBold, 41.5);
        
        page.drawText(additionalSpeedText, {
            x: additionalSpeedX,
            y: height - 450,
            size: 44,
            font: GraphieBold,
            color: PDFLib.rgb(0, 0, 0)
        });

        const additionalUnitsX = additionalSpeedX + additionalSpeedWidth + 10;
        page.drawText(`${additionalUnits}`, {
            x: additionalUnitsX,
            y: height - 439,
            size: 16,
            font: GraphieBold,
            color: PDFLib.rgb(0, 0, 0)
        });

        // Additional Price with fixed positioning
        const priceX = 445;
        
        page.drawText(`$`, {
            x: priceX,
            y: height - 438,
            size: 23,
            font: GraphieBold,
            color: PDFLib.rgb(0.263, 0.306, 0.631)
        });

        const priceText = `${additionalPrice}`;
        page.drawText(priceText, {
            x: priceX + 13,
            y: height - 445,
            size: 33,
            font: GraphieBold,
            color: PDFLib.rgb(0.263, 0.306, 0.631)
        });

        page.drawText(`/mo`, {
            x: priceX + 15 + getTextWidth(priceText, GraphieBold, 33),
            y: height - 435,
            size: 16,
            font: GraphieBold,
            color: PDFLib.rgb(0.263, 0.306, 0.631)
        });

        // QR Code
        page.drawImage(qrImage, {
            x: 50,
            y: height - 300,
            width: 70,
            height: 70
        });
    }

    const pdfBytes = await pdfDoc.save();
    currentPdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
    document.getElementById('pdfPreview').src = URL.createObjectURL(currentPdfBlob);
}
function handleDownload() {
    if (!currentPdfBlob) {
        alert('Please confirm and preview first!');
        return;
    }
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(currentPdfBlob);
    link.download = 'annotated-document.pdf';
    link.click();
}
    </script>
  </body>
</html>